<form id="markdown-form">
    <input type="hidden" id="pageId" name="id" value="$!wikiPage.id" />
    <input type="hidden" name="parentId" value="$!wikiPage.parentId" />
    <input type="hidden" id="wiki-val" name="wiki" />
    <div>
        <div class="btn-toolbar form-inline">
         <select id="theme" size="1">
          <optgroup label="Bright">
            <option value="ace/theme/chrome">Chrome</option>
            <option value="ace/theme/clouds">Clouds</option>
            <option value="ace/theme/crimson_editor">Crimson Editor</option>
            <option value="ace/theme/dawn">Dawn</option>
            <option value="ace/theme/dreamweaver">Dreamweaver</option>
            <option value="ace/theme/eclipse">Eclipse</option>
            <option value="ace/theme/github">GitHub</option>
            <option value="ace/theme/solarized_light">Solarized Light</option>
            <option value="ace/theme/textmate" selected="selected">TextMate</option>
            <option value="ace/theme/tomorrow">Tomorrow</option>
            <option value="ace/theme/xcode">XCode</option>
          </optgroup>
          <optgroup label="Dark">
            <option value="ace/theme/ambiance">Ambiance</option>
            <option value="ace/theme/chaos">Chaos</option>
            <option value="ace/theme/clouds_midnight">Clouds Midnight</option>
            <option value="ace/theme/cobalt">Cobalt</option>
            <option value="ace/theme/idle_fingers">idleFingers</option>
            <option value="ace/theme/kr_theme">krTheme</option>
            <option value="ace/theme/merbivore">Merbivore</option>
            <option value="ace/theme/merbivore_soft">Merbivore Soft</option>
            <option value="ace/theme/mono_industrial">Mono Industrial</option>
            <option value="ace/theme/monokai">Monokai</option>
            <option value="ace/theme/pastel_on_dark">Pastel on dark</option>
            <option value="ace/theme/solarized_dark">Solarized Dark</option>
            <option value="ace/theme/twilight">Twilight</option>
            <option value="ace/theme/tomorrow_night">Tomorrow Night</option>
            <option value="ace/theme/tomorrow_night_blue">Tomorrow Night Blue</option>
            <option value="ace/theme/tomorrow_night_bright">Tomorrow Night Bright</option>
            <option value="ace/theme/tomorrow_night_eighties">Tomorrow Night 80s</option>
            <option value="ace/theme/vibrant_ink">Vibrant Ink</option>
          </optgroup>
        </select>
        <input type="text" name="title" class="input-xxlarge" value="$!esc.html($!wikiPage.title)" placeholder="title"/>
        <div class="btn-group">
             <a id="btn-save" class="btn btn-primary">save</a>
             <a class="btn">preview</a>
        </div>
        </div>
    </div>
    <div id="edit-form-wrapper" style="margin: 50px; display:none;">
        <div id="markdown-editor"/>$!esc.html($!wikiPage.wiki)</div>
    </div>
</form>
<script>
$(function(){
    var editor = ace.edit("markdown-editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/markdown");
    editor.session.setUseWrapMode(true);
    
    $('#theme').change(function(){
        editor.setTheme($(this).val());
    });
    
    function saveWiki(){
        $('#wiki-val').val(editor.getValue());
        $.post("/post_page", $('#markdown-form').serialize(), function(data){
        	if(data.id != undefined && data.id != undefined > 0){
        	    console.info("post wiki success");
        	   $('#pageId').val(data.id);
        	}
        }, 'json');
    }
    $('#btn-save').click(saveWiki);
    $(document).bind('keydown', 'Ctrl+s', saveWiki);
    editor.commands.addCommand({
        name: 'markdown-save',
        bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
        exec: saveWiki
    });
    editor.commands.addCommand({
        name: 'markdown-preview',
        bindKey: {win: 'Ctrl-P',  mac: 'Command-P'},
        exec: function(editor) {
           jQuery.post('/api-wiki/render', {
            'wiki' : editor.getValue()
            }, function(data) {
                $('#wiki-content').html(data);
                $('#edit-form-wrapper').toggle();
                $('#wiki-content-preview').toggle();
            });
        }
    });
    $('#edit-form-wrapper').show();
});
</script>
